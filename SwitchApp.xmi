
#import "SwitchApp.h"

@implementation SwitchAppWindow

+ (BOOL)shouldActivate {
    return YES;
    return [SBApp _accessibilityFrontMostApplication] != nil
        && [SBApp activeInterfaceOrientation] == UIInterfaceOrientationPortrait
        && ![[objc_getClass("SBUIController") sharedInstance] isSwitcherShowing];
}

- (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event {
    if (![[self class] shouldActivate]) return;

    id uic = [objc_getClass("SBUIController") sharedInstance];
    [uic _switchAppGestureBegan];
}

- (void)touchesMoved:(NSSet *)touches withEvent:(UIEvent *)event {
    if (![[self class] shouldActivate]) return;

    id uic = [objc_getClass("SBUIController") sharedInstance];
    CGPoint pt = [[touches anyObject] locationInView:self];
    [uic _switchAppGestureChanged:(pt.x / [[UIScreen mainScreen] bounds].size.width)];
}

- (void)touchesEnded:(NSSet *)touches withEvent:(UIEvent *)event {
    if (![[self class] shouldActivate]) return;

    // XXX: choose the correct completion type here

    id uic = [objc_getClass("SBUIController") sharedInstance];
    CGPoint pt = [[touches anyObject] locationInView:self];
    [uic _switchAppGestureEndedWithCompletionType:1 cumulativePercentage:(pt.x / [[UIScreen mainScreen] bounds].size.width)];
}

@end

%group SwitchApp

%hook SBUIController

// This is dumb as fuck. The "has multitasking gestures" state is stored in
// a random global variable which we cannot hook, and is set in a C function
// without an (exposed) name, so we also cannot hook that. This C function is
// called from dozens of methods, and as such cannot be hooked, especially as
// many of those functions that call it /break/ if you apply the necessary
// hooks around them (as well as the C function setting the varaible). Ugh. :(
- (void)_switchAppGestureBegan {
    SBApplication *topApplication = [SBApp _accessibilityFrontMostApplication];

    if (topApplication != nil) {
        if ([topApplication displayFlag:0x3]) return;
        if (![topApplication displayFlag:0x1]) return;
    }

    // (there is some condition here in a C function, dunno what it does)
    if (![self _dismissSheetsAndDetermineAlertStateForMenuClickOrSystemGesture]) return;

    if (topApplication == nil) {
        topApplication = MSHookIvar<SBApplication *>(self, "_pendingAppActivatedByGesture");
        if (topApplication == nil) return;
    }

    NSMutableArray *unfilteredList = MSHookIvar<NSMutableArray *>(self, "_switchAppFullyOrderedList");
    if (unfilteredList == nil) {
        [self _calculateSwitchAppList];
        unfilteredList = MSHookIvar<NSMutableArray *>(self, "_switchAppFullyOrderedList");
    }

    NSArray *filteredList = [self _makeSwitchAppFilteredList:unfilteredList initialApp:topApplication];
    int topApplicationIndex = [filteredList indexOfObject:[topApplication displayIdentifier]];

    if ([filteredList count] == 0 || topApplicationIndex == NSNotFound) return;

    id bulletinListController = [objc_getClass("SBBulletinListController") sharedInstanceIfExists];
    if ([bulletinListController listViewIsActive]) {
        [bulletinListController hideListViewAnimated:YES];
    }

    MSHookIvar<BOOL>(self, "_switcherVisibleWhenSwitchAppGestureStarted") = [self isSwitcherShowing];

    [self clearPendingAppActivatedByGesture];
    [self _lockOrientationForSystemGesture];
    [self cleanupSwitchAppGestureViews];

    if (topApplication != nil) {
        if (![topApplication displayFlag:0x22]) {
            if (![topApplication displayFlag:0x1]) {
                if ([topApplication suspensionType] == 0) {
                    // call some C functions, that sorta do this (i'm too lazy to reverse these:)
                    [topApplication setDeactivationSetting:0xC flag:YES];
                    [[topApplication process] killWithSignal:9];
                }
            }
        } else {
            [self notifyAppResignActive:topApplication];
        }
    }

    // some c function... and another one.. sorta the second one below
    UIInterfaceOrientation currentOrientation = [SBApp activeInterfaceOrientation]; // also someting about "CAMediaTime", huh
    [[UIDevice currentDevice] setOrientation:currentOrientation animated:NO];
    [SBApp noteInterfaceOrientationChanged:currentOrientation];

    [self showSystemGestureBackdrop];

    id applicationController = [objc_getClass("SBApplicationController") sharedInstance];
    SBApplication *leftApplication = [applicationController applicationWithDisplayIdentifier:[filteredList objectAtIndex:0]];
    SBApplication *rightApplication = [applicationController applicationWithDisplayIdentifier:[filteredList lastObject]];

    if (leftApplication == topApplication) leftApplication = nil;
    if (rightApplication == topApplication) rightApplication = nil;

    [MSHookIvar<SBSwitchAppGestureView *>(self, "_switchAppGestureView") removeFromSuperview];
    [MSHookIvar<SBSwitchAppGestureView *>(self, "_switchAppGestureView") release];

    MSHookIvar<SBSwitchAppGestureView *>(self, "_switchAppGestureView") = [[objc_getClass("SBSwitchAppGestureView") alloc] initWithInterfaceOrientation:currentOrientation startingApp:topApplication leftwardApp:leftApplication rightwardApp:rightApplication];

    [MSHookIvar<UIView *>(self, "_contentView") addSubview:MSHookIvar<id>(self, "_switchAppGestureView")];
    [MSHookIvar<SBSwitchAppGestureView *>(self, "_switchAppGestureView") beginPaging];

    [self prepareSwitchAppGestureStatusBar];
    [self setRootViewHiddenForScatter:0 duration:0.0 startTime:0.0];
    [self updateSwitchAppGestureStatusBar];

    if ([self isSwitcherShowing]) {
        [self _dismissShowcase:0.0f unhost:NO];
    }
}

- (void)_switchAppGestureChanged:(CGFloat)percentage {
    [MSHookIvar<SBSwitchAppGestureView *>(self, "_switchAppGestureView") updatePaging:percentage];
    [self updateSwitchAppGestureStatusBar];
}

- (void)_switchAppGestureEndedWithCompletionType:(int)type cumulativePercentage:(float)percentage {
    SBSwitchAppGestureView *gestureView = MSHookIvar<SBSwitchAppGestureView *>(self, "_switchAppGestureView");

    id completion = ^{
        [self _switchAppGestureViewAnimationComplete];
    };

    if (type == 1) {
        [gestureView finishForwardToEndWithPercentage:percentage completion:completion];
    } else if (type == 0) {
        [gestureView finishBackwardToStartWithCompletion:completion];
    }

    [self updateSwitchAppGestureStatusBar];
}

- (void)_switchAppGestureViewAnimationComplete {
    SBSwitchAppGestureView *gestureView = MSHookIvar<SBSwitchAppGestureView *>(self, "_switchAppGestureView");
    if (gestureView == nil) return;

    [self hideSystemGestureBackdrop];

    SBApplication *startingApplication = [gestureView startingApp];
    SBApplication *endingApplication = [gestureView endingApp];

    [gestureView removeFromSuperview];
    [gestureView release];
    MSHookIvar<SBSwitchAppGestureView *>(self, "_switchAppGestureView") = nil;

    BOOL endingAppHasLaunchedFrontmost = [endingApplication displayFlag:1];

    [self clearZoomLayer];

    if (startingApplication != endingApplication) {
        UIInterfaceOrientation statusOrientation = [startingApplication statusBarOrientation];
        [startingApplication setDeactivationSetting:0x18 flag:YES];

        /* sub_2C330 */ {
            if ([SBWActiveDisplayStack containsDisplay:startingApplication] || [SBWSuspendedEventOnlyDisplayStack containsDisplay:startingApplication]) {
                /* sub_2B9B8 */ {
                    // this is a crude approximation of sorta kinda what this gigantic
                    // function does, since I'm waaaaay too lazy to reverse the whole
                    // thing: even just the graph in IDA is quite scary to look at! :(
                    [SBWActiveDisplayStack popDisplay:startingApplication];
                    [SBWSuspendingDisplayStack pushDisplay:startingApplication];
                }
            } else if (![SBWSuspendingDisplayStack containsDisplay:startingApplication]) {
                [startingApplication clearDeactivationSettings];
            }
        }
    }

    id applicationController = [objc_getClass("SBApplicationController") sharedInstance];
    for (NSString *displayIdentifier in MSHookIvar<NSArray *>(self, "_switchAppFilteredList")) {
        SBApplication *application = [applicationController applicationWithDisplayIdentifier:displayIdentifier];

        if (application != endingApplication) {
            [application disableContextHostingForRequester:CFSTR("SwitchApp")];
        }
    }

    [self cleanupSwitchAppGestureViews];

    BOOL shouldShowSwitcherAgain = NO;

    if (!endingAppHasLaunchedFrontmost) {
        // ending app hasn't launched; launch it now
        [self showSystemGestureBackdrop];
        [self scheduleApplicationForLaunchByGesture:endingApplication];
        [self _installSwitchAppGesturePlaceholderViewForEndingApp:endingApplication];

        shouldShowSwitcherAgain = YES;
    } else {
        [endingApplication disableContextHostingForRequester:CFSTR("SwitchApp")];
        [endingApplication disableContextHostingForRequester:CFSTR("LaunchSuspend")];

        if (startingApplication == endingApplication) {
            // ending app is same as starting app, resume it
            [self notifyAppResumeActive:endingApplication];

            shouldShowSwitcherAgain = YES;
        } else {
            // ending app needs to be re-launched, do it
            [self showSystemGestureBackdrop];
            [self scheduleApplicationForLaunchByGesture:endingApplication];
            [self _installSwitchAppGesturePlaceholderViewForEndingApp:endingApplication];
        }
    }

    if (shouldShowSwitcherAgain && MSHookIvar<BOOL>(self, "_switcherVisibleWhenSwitchAppGestureStarted")) {
        // show switcher again if it was hidden for the gesture to start

        id appSwitcherController = [objc_getClass("SBAppSwitcherController") sharedInstance];
        id zeroContext = [self _showcaseContextForOffset:0];
        id barContext = [self _showcaseContextForOffset:[self bottomBarHeight]];

        UIInterfaceOrientation currentOrientation = [SBApp activeInterfaceOrientation]; // also someting about "CAMediaTime", huh
        [zeroContext setShowcaseOrientation:currentOrientation];
        [barContext setShowcaseOrientation:currentOrientation];

        [self _activateSwitcherFrom:zeroContext to:barContext duration:0];
    }

    MSHookIvar<BOOL>(self, "_switcherVisibleWhenSwitchAppGestureStarted") = NO;
    MSHookIvar<BOOL>(self, "_switchAppGestureStatusBarMaintained") = NO;

    // two more C functions; unknown purpose

    [self _resumeEventsIfNecessary];

    if (endingAppHasLaunchedFrontmost) {
        [self _releaseSystemGestureOrientationLock];
    }
}

- (void)finishLaunching {
    CGFloat windowPercentage = 0.03f;
    CGRect windowFrame;

    windowFrame = [[UIScreen mainScreen] bounds];
    windowFrame.size.width *= windowPercentage;
    [[SwitchAppWindow alloc] initWithFrame:windowFrame];

    windowFrame = [[UIScreen mainScreen] bounds];
    windowFrame.origin.x += windowFrame.size.width * (1.0f - windowPercentage);
    windowFrame.size.width *= windowPercentage;
    [[SwitchAppWindow alloc] initWithFrame:windowFrame];

    %orig;
}

%end

%end

%ctor {
    %init(SwitchApp);
}

