#import "Common.h"
#import "Notification.h"
#import "Preferences.h"
#import "Keyboard.h"
#import "NSTimer+Blocks.h"

#import "SwitchApp.h"

#include <dlfcn.h>

%group Notification

@interface SBBulletinListController (Zephyr)
- (BOOL)shouldActivate;
- (void)cleanupViews;
- (void)prepareAtLocation:(CGFloat)location;
@end

%hook SBBulletinListController

static UIView *appView = nil;
static SBBulletinListView *centerView = nil;
static UIImageView *shadowView = nil;
static CGFloat grabLocation = NAN;

%new(c@:)
- (BOOL)shouldActivate {
    BOOL preference = [PreferencesGet(@"NotificationEnabled", [NSNumber numberWithBool:YES]) boolValue];
    BOOL ipad = [[UIDevice currentDevice] userInterfaceIdiom] == UIUserInterfaceIdiomPad;

    return preference && !ipad;
}

%new(v@:)
- (void)cleanupViews {
    SBApplication *app = [SBApp _accessibilityFrontMostApplication];

    if (app != nil) {
        [app disableContextHostingForRequester:(CFStringRef) @"SwitchApp"];
    }

    centerView = nil;

    [shadowView release];
    [shadowView removeFromSuperview];
    shadowView = nil;

    [appView release];
    [appView removeFromSuperview];
    appView = nil;
}

- (void)_cleanupAfterShowListView {
    if (![self shouldActivate]) return %orig;

    %orig;
    grabLocation = NAN;
    [self cleanupViews];
}

- (void)_cleanupAfterHideListView {
    if (![self shouldActivate]) return %orig;

    %orig;
    grabLocation = NAN;
    [self cleanupViews];
}

- (void)prepareToShowListViewAnimated:(BOOL)showListViewAnimated aboveBanner:(BOOL)banner {
    if (![self shouldActivate]) return %orig;

    %orig;
    [self prepareAtLocation:0.0f];
}

- (void)prepareToHideListViewAnimated:(BOOL)animated {
    if (![self shouldActivate]) return %orig;

    %orig;

    if (!isnan(grabLocation)) {
        [self prepareAtLocation:grabLocation];
    } else {
        [self prepareAtLocation:ZephyrHeightForOrientation(ZephyrCurrentInterfaceOrientation())];
    }
}

%new(v@:f)
- (void)prepareAtLocation:(CGFloat)location {
    [self cleanupViews];
    grabLocation = location;

    centerView = [self listView];
    [centerView positionSlidingViewAtY:ZephyrHeightForOrientation(ZephyrCurrentInterfaceOrientation())];

    appView = [[UIView alloc] initWithFrame:[centerView bounds]];
    [appView setClipsToBounds:NO];
    [centerView addSubview:appView];

    SBApplication *app = [SBApp _accessibilityFrontMostApplication];

    if (app != nil) {
        UIView *gestureView = [[objc_getClass("SBGestureViewVendor") sharedInstance] viewForApp:app gestureType:kSBGestureTypeSwitchApp includeStatusBar:YES];

        UIView *gestureWrapperView = [[UIView alloc] initWithFrame:[appView bounds]];
        [gestureWrapperView addSubview:gestureView];
        [appView addSubview:gestureWrapperView];

        if (!UIInterfaceOrientationIsPortrait(ZephyrCurrentInterfaceOrientation())) {
            ZephyrRotateViewFromOrientationToOrientation(gestureWrapperView, UIInterfaceOrientationPortrait, ZephyrOrientationFlip(ZephyrCurrentInterfaceOrientation()), YES);
        }
    } else {
        // XXX: using contentView here isn't necessarily the best option, but it works.
        UIView *homeView = ZephyrViewWithScreenshotOfView([[objc_getClass("SBUIController") sharedInstance] contentView]);
        [appView addSubview:homeView];
    }

    shadowView = [[UIImageView alloc] initWithImage:[UIImage imageNamed:@"SwitcherShadowTop.png"]];
    CGRect shadowFrame = [shadowView frame];
    shadowFrame.size.height = [[shadowView image] size].height;
    shadowFrame.size.width = [appView bounds].size.width;
    shadowFrame.origin.y = location - shadowFrame.size.height;
    [shadowView setFrame:shadowFrame];
    [shadowView setTransform:CGAffineTransformMakeScale(1, -1)];
    [centerView addSubview:shadowView];

    CGRect appFrame = [appView frame];
    appFrame.origin.y = location;
    [appView setFrame:appFrame];
}

- (void)positionListViewAtY:(CGFloat)location {
    if (![self shouldActivate]) return %orig;

    grabLocation = location;

    if (location < 0) location = 0;

    CGRect wrapperFrame = [appView frame];
    wrapperFrame.origin.y = location;
    [appView setFrame:wrapperFrame];

    CGRect shadowFrame = [shadowView frame];
    shadowFrame.origin.y = wrapperFrame.origin.y - shadowFrame.size.height;
    [shadowView setFrame:shadowFrame];
}

%end

%hook SBBulletinListView

// we fake the location in order to show the notification UI
// while we are sliding down, so re-fake back the current Y
- (CGFloat)currentY {
    if (!isnan(grabLocation)) {
        return grabLocation;
    } else {
        return %orig;
    }
}

%end

%end

%ctor {
    %init(Notification);
}

