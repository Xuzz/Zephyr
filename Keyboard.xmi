
#import "CPDistributedMessagingCenter.h"
#import "iPhonePrivate.h"
#import "Keyboard.h"

static NSMutableSet *applicationsWithActiveKeyboard = nil;

%ctor {
    // XXX: is this a memory leak?
    applicationsWithActiveKeyboard = [[NSMutableSet alloc] init];
}

BOOL KeyboardIsActive() {
    NSString *displayIdentifier = [[SBApp _accessibilityFrontMostApplication] displayIdentifier];

    return [applicationsWithActiveKeyboard containsObject:displayIdentifier];
}

@interface KeyboardServer : NSObject {
    CPDistributedMessagingCenter *messagingCenter;
}

- (void)startServer;

@end

@implementation KeyboardServer

- (id)init {
    if ((self = [super init]) != nil) {
        messagingCenter = [CPDistributedMessagingCenter centerNamed:@"com.chpwn.zephyr.keyboard"];

        [messagingCenter registerForMessageName:@"keyboardActivated" target:self selector:@selector(handleKeyboardActivatedMessage:withUserInfo:)];
        [messagingCenter registerForMessageName:@"keyboardDeactivated" target:self selector:@selector(handleKeyboardDeactivatedMessage:withUserInfo:)];
    }

    return self;
}

- (void)startServer {
    [messagingCenter runServerOnCurrentThread];
}

- (NSDictionary *)handleKeyboardActivatedMessage:(NSString *)name withUserInfo:(NSDictionary *)userInfo {
    NSString *displayIdentifier = [userInfo objectForKey:@"displayIdentifier"];
    [applicationsWithActiveKeyboard addObject:displayIdentifier];
    return nil;
}

- (NSDictionary *)handleKeyboardDeactivatedMessage:(NSString *)name withUserInfo:(NSDictionary *)userInfo {
    NSString *displayIdentifier = [userInfo objectForKey:@"displayIdentifier"];
    [applicationsWithActiveKeyboard removeObject:displayIdentifier];
    return nil;
}

@end

%group Keyboard

%hook SBUIController

- (void)applicationHasDied:(SBApplication *)application {
    NSString *displayIdentifier = [application displayIdentifier];
    [applicationsWithActiveKeyboard removeObject:displayIdentifier];

    %orig;
}

%end

%end

%ctor {
    %init(Keyboard);

    // XXX: is this a memory leak?
    static KeyboardServer *server = [[KeyboardServer alloc] init];
    [server startServer];
}


