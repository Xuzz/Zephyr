
#import "CPDistributedMessagingCenter.h"
#import "iPhonePrivate.h"
#import "Keyboard.h"

static NSMutableSet *applicationsWithActiveKeyboard = nil;
static BOOL springboardKeyboardActive = NO;

%ctor {
    // XXX: is this a memory leak?
    applicationsWithActiveKeyboard = [[NSMutableSet alloc] init];
}

BOOL ZephyrKeyboardIsActive() {
    NSString *displayIdentifier = [[SBApp _accessibilityFrontMostApplication] displayIdentifier];

    if (displayIdentifier != nil) {
        return [applicationsWithActiveKeyboard containsObject:displayIdentifier];
    } else {
        return springboardKeyboardActive;
    }
}

@interface ZephyrKeyboardServer : NSObject {
    CPDistributedMessagingCenter *messagingCenter;
}

- (void)startServer;

@end

@implementation ZephyrKeyboardServer

- (id)init {
    if ((self = [super init]) != nil) {
        messagingCenter = [CPDistributedMessagingCenter centerNamed:@"com.chpwn.zephyr.keyboard"];

        [messagingCenter registerForMessageName:@"keyboardActivated" target:self selector:@selector(handleKeyboardActivatedMessage:withUserInfo:)];
        [messagingCenter registerForMessageName:@"keyboardDeactivated" target:self selector:@selector(handleKeyboardDeactivatedMessage:withUserInfo:)];
    }

    return self;
}

- (void)startServer {
    [messagingCenter runServerOnCurrentThread];
}

- (NSDictionary *)handleKeyboardActivatedMessage:(NSString *)name withUserInfo:(NSDictionary *)userInfo {
    NSString *displayIdentifier = [userInfo objectForKey:@"displayIdentifier"];
    [applicationsWithActiveKeyboard addObject:displayIdentifier];
    return nil;
}

- (NSDictionary *)handleKeyboardDeactivatedMessage:(NSString *)name withUserInfo:(NSDictionary *)userInfo {
    NSString *displayIdentifier = [userInfo objectForKey:@"displayIdentifier"];
    [applicationsWithActiveKeyboard removeObject:displayIdentifier];
    return nil;
}

- (void)springboardKeyboardActivated {
    springboardKeyboardActive = YES;
}

- (void)springboardKeyboardDeactivated {
    springboardKeyboardActive = NO;
}

@end

%group Keyboard

%hook SBUIController

- (void)applicationHasDied:(SBApplication *)application {
    NSString *displayIdentifier = [application displayIdentifier];
    [applicationsWithActiveKeyboard removeObject:displayIdentifier];

    %orig;
}

%end

%end

%ctor {
    %init(Keyboard);

    // XXX: is this a memory leak?
    static ZephyrKeyboardServer *server = [[ZephyrKeyboardServer alloc] init];
    [[NSNotificationCenter defaultCenter] addObserver:server selector:@selector(springboardKeyboardActivated) name:UIKeyboardWillShowNotification object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:server selector:@selector(springboardKeyboardDeactivated) name:UIKeyboardWillHideNotification object:nil];
    [server startServer];
}


